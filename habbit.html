<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­ç¿’æ…£æ‰“å¡è¿½è¹¤å™¨</title>
    <style>
        /* CSS æ¨£å¼å€åŸŸ */
        :root {
            --primary-color: #4CAF50;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        h1 { margin-bottom: 20px; }

        /* è¼¸å…¥å€åŸŸ */
        .input-group {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 600px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        button.add-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        button.add-btn:hover { background-color: #45a049; }

        /* ç¿’æ…£å¡ç‰‡åˆ—è¡¨ */
        #habit-list {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .habit-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .habit-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .habit-stats {
            font-size: 0.9rem;
            color: #666;
        }

        .streak-badge {
            background-color: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* æ—¥æ›†è¦–åœ– UI */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* ä¸€é€±ä¸ƒå¤© */
            gap: 5px;
        }

        .day-cell {
            aspect-ratio: 1; /* ä¿æŒæ­£æ–¹å½¢ */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            background-color: #eee;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            user-select: none;
        }

        .day-cell:hover { background-color: #ddd; }

        /* æ‰“å¡å¾Œçš„æ¨£å¼ */
        .day-cell.checked {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        /* ä»Šå¤©æ—¥æœŸçš„ç‰¹æ®Šé‚Šæ¡† */
        .day-cell.today {
            border: 2px solid #333;
        }

    </style>
</head>
<body>

    <h1>ğŸš€ åŸå­ç¿’æ…£è¿½è¹¤å™¨</h1>

    <div class="input-group">
        <input type="text" id="habitInput" placeholder="è¼¸å…¥ä½ æƒ³é¤Šæˆçš„ç¿’æ…£ (ä¾‹ï¼šé–±è®€30åˆ†é˜)...">
        <button class="add-btn" onclick="addHabit()">æ–°å¢ç¿’æ…£</button>
    </div>

    <div id="habit-list">
        </div>

    <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxVfz80tq4229sb6Jrl7e_M1wMIildpklf4SP6E5nRP2j4n-oLH2ak5eLJk9WAPRV4/exec"; // è¨˜å¾—ç¢ºèªç¶²å€æ²’è®Š
        let habits = [];
        
        // --- æ–°å¢ï¼šä½¿ç”¨è€…åç¨±ç®¡ç† ---
        // å˜—è©¦å¾ç€è¦½å™¨è¨˜æ†¶é«”å–å¾—åå­—ï¼Œæ²’æœ‰çš„è©±é è¨­ç‚º "guest"
        let currentUser = localStorage.getItem('habit_user') || 'guest';

        // æ—¥æœŸè¨­å®š (ç¶­æŒä¸è®Š)
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth(); 
        const currentDay = today.getDate();

        // åˆå§‹åŒ–
        init();

        async function init() {
            // æç¤ºä½¿ç”¨è€…è¼¸å…¥åå­— (ç°¡å–®çš„ç™»å…¥æ©Ÿåˆ¶)
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é€²ä¾†ï¼Œæˆ–è€…æ˜¯ guestï¼Œå°±å•åå­—
            if (currentUser === 'guest') {
                const name = prompt("è«‹è¼¸å…¥ä½ çš„æš±ç¨± (é€™æœƒç”¨ä¾†å€åˆ†ä½ çš„è³‡æ–™):", "Guest");
                if (name) {
                    currentUser = name;
                    localStorage.setItem('habit_user', currentUser); // è¨˜ä½åå­—
                }
            }
            
            // åœ¨æ¨™é¡Œé¡¯ç¤ºæ­¡è¿
            document.querySelector('h1').innerText = `ğŸš€ ${currentUser} çš„ç¿’æ…£è¿½è¹¤`;

            showLoading(true);
            try {
                await loadHabitsFromCloud();
            } catch (error) {
                console.error(error);
            }
            renderHabits();
            showLoading(false);
        }

        // --- ä¿®æ”¹ API å‘¼å« ---

        // 1. è®€å– (GET) - åŠ ä¸Š user åƒæ•¸
        async function loadHabitsFromCloud() {
            if (!API_URL.includes("http")) return;
            // åœ¨ç¶²å€å¾Œé¢åŠ ä¸Š ?user=åå­—
            const response = await fetch(`${API_URL}?user=${encodeURIComponent(currentUser)}`);
            const data = await response.json();
            habits = data;
        }

        // 2. å„²å­˜ (POST) - å‚³é€ user è³‡æ–™
        async function saveToCloud() {
            renderHabits(); 
            
            // Payload è£¡å¤šåŒ…ä¸€å€‹ user æ¬„ä½
            const payload = JSON.stringify({ 
                user: currentUser,
                habits: habits 
            });
            
            fetch(API_URL, {
                method: "POST",
                body: payload
            }).then(res => console.log("åŒæ­¥æˆåŠŸ"))
            .catch(err => console.error(err));
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ (ä¿®æ”¹å¾Œ) ---

        function addHabit() {
            const input = document.getElementById('habitInput');
            const name = input.value.trim();
            if (!name) return alert("è«‹è¼¸å…¥ç¿’æ…£åç¨±ï¼");

            const newHabit = {
                id: Date.now(),
                name: name,
                logs: []
            };

            habits.push(newHabit);
            input.value = '';
            saveToCloud(); // æ”¹ç”¨é›²ç«¯å„²å­˜
        }

        function deleteHabit(id) {
            if(confirm("ç¢ºå®šè¦æ”¾æ£„é€™å€‹ç¿’æ…£å—ï¼Ÿ")) {
                habits = habits.filter(h => h.id !== id);
                saveToCloud(); // æ”¹ç”¨é›²ç«¯å„²å­˜
            }
        }

        function toggleCheck(habitId, day) {
            const habit = habits.find(h => h.id === habitId);
            
            // --- ä¿®æ”¹è™•é–‹å§‹ï¼šæ ¼å¼æ”¹ç‚º MM/DD ---
            // String(...).padStart(2, '0') ç¢ºä¿ 5æœˆè®Šæˆ '05'
            const dateStr = `${String(currentMonth + 1).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
            // --- ä¿®æ”¹è™•çµæŸ ---
            
            if (habit.logs.includes(dateStr)) {
                habit.logs = habit.logs.filter(d => d !== dateStr);
            } else {
                habit.logs.push(dateStr);
            }
            saveToCloud();
        }

        // --- è¦–åœ–æ¸²æŸ“èˆ‡è¨ˆç®—é‚è¼¯ (ä¿æŒä¸è®Šï¼Œä½†åœ¨é€™è£¡åŠ ä¸Š Loading æ•ˆæœ) ---
        
        function showLoading(isLoading) {
            const list = document.getElementById('habit-list');
            if (isLoading) {
                list.innerHTML = '<div style="text-align:center; padding:20px;">â˜ï¸ æ­£åœ¨èˆ‡ Google åŒæ­¥ä¸­...</div>';
            }
        }

        function renderHabits() {
            const list = document.getElementById('habit-list');
            list.innerHTML = '';

            if (habits.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#888;">ç›®å‰æ²’æœ‰ç¿’æ…£ï¼Œæ–°å¢ä¸€å€‹å§ï¼</div>';
                return;
            }

            habits.forEach(habit => {
                const streak = calculateStreak(habit.logs);
                const rate = calculateMonthlyRate(habit.logs);

                const card = document.createElement('div');
                card.className = 'habit-card';
                card.innerHTML = `
                    <div class="habit-header">
                        <div>
                            <span class="habit-title">${habit.name}</span>
                            <span class="streak-badge">ğŸ”¥ é€£å‹: ${streak} å¤©</span>
                        </div>
                        <div class="habit-stats">
                            æœ¬æœˆé”æˆç‡: <strong>${rate}%</strong>
                            <button class="delete-btn" onclick="deleteHabit(${habit.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        ${generateCalendarHTML(habit)}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // ... (generateCalendarHTML, calculateStreak, calculateMonthlyRate å‡½æ•¸ä¿æŒåŸæœ¬çš„ç¨‹å¼ç¢¼å³å¯ï¼Œä¸éœ€è®Šå‹•) ...
        
        // ç‚ºäº†å®Œæ•´æ€§ï¼Œè«‹å°‡åŸæœ¬çš„ generateCalendarHTML, calculateStreak, calculateMonthlyRate è¤‡è£½è²¼ä¸Šåœ¨ä¸‹æ–¹
        // (é€™è£¡çœç•¥é‡è¤‡ä»£ç¢¼ä»¥ç¯€çœç©ºé–“ï¼Œè«‹ä½¿ç”¨ä¸Šä¸€ç‰ˆçš„å›è¦†ä¸­çš„é€™ä¸‰å€‹å‡½æ•¸)
        
        function generateCalendarHTML(habit) {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let html = '';

            for (let day = 1; day <= daysInMonth; day++) {
                // --- ä¿®æ”¹è™•é–‹å§‹ï¼šæ¯”å°çš„æ ¼å¼ä¹Ÿè¦æ”¹æˆ MM/DD ---
                const dateStr = `${String(currentMonth + 1).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
                // --- ä¿®æ”¹è™•çµæŸ ---

                const isChecked = habit.logs.includes(dateStr);
                const isToday = (day === currentDay);

                html += `
                    <div class="day-cell ${isChecked ? 'checked' : ''} ${isToday ? 'today' : ''}" 
                        onclick="toggleCheck(${habit.id}, ${day})"
                        title="${dateStr}">
                        ${day}
                    </div>
                `;
            }
            return html;
        }
        function calculateStreak(logs) {
            if (!logs || logs.length === 0) return 0;
            
            let streak = 0;
            // æˆ‘å€‘å¾€å›æª¢æŸ¥ 365 å¤©
            for (let i = 0; i < 365; i++) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                
                // --- ä¿®æ”¹è™•é–‹å§‹ï¼šå°‡å›æ¨çš„æ—¥æœŸä¹Ÿè½‰æˆ MM/DD æ ¼å¼ä¾†æ¯”å° ---
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const dStr = `${month}/${day}`;
                // --- ä¿®æ”¹è™•çµæŸ ---
                
                if (logs.includes(dStr)) {
                    streak++;
                } else {
                    // å¦‚æœæ˜¯ä»Šå¤©æ²’æ‰“å¡ï¼Œå…ˆæ”¾éï¼ˆå¯èƒ½æ™šä¸Šæ‰æ‰“ï¼‰ï¼Œä½†å¦‚æœæ˜¯æ˜¨å¤©ä»¥å‰æ²’æ‰“ï¼Œå°±æ–·äº†
                    if (i === 0) continue; 
                    break;
                }
            }
            return streak;
        }

        function calculateMonthlyRate(logs) {
            if (!logs) return 0;
            
            // ç›®æ¨™æ ¼å¼ï¼šé–‹é ­è¦æ˜¯ "MM/" (ä¾‹å¦‚ "12/")
            const currentMonthPrefix = String(currentMonth + 1).padStart(2, '0') + "/";
            
            // éæ¿¾å‡ºé–‹é ­ç¬¦åˆæœ¬æœˆçš„ log
            const thisMonthLogs = logs.filter(log => log.startsWith(currentMonthPrefix));
            
            return Math.round((thisMonthLogs.length / currentDay) * 100);
        }
    </script>
</body>
</html>